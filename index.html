<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveBridge - Secure Cloud File Transfer</title>
    <meta name="description" content="Secure, chunked file transfer between Google Drive and OneDrive with verbose logging">
    <meta name="keywords" content="cloud transfer, google drive, onedrive, file sync, secure transfer">
    <meta name="author" content="DriveBridge">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://alcdn.msauth.net; connect-src 'self' https://www.googleapis.com https://graph.microsoft.com https://login.microsoftonline.com; style-src 'self' 'unsafe-inline'; img-src 'self'  https:; frame-src https://accounts.google.com https://login.microsoftonline.com;">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüåâ%3C/text%3E%3C/svg%3E">
    
    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://apis.google.com">
    <link rel="preconnect" href="https://accounts.google.com">
    <link rel="preconnect" href="https://graph.microsoft.com">
    <link rel="preconnect" href="https://login.microsoftonline.com">
    
    <!-- Load external scripts -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js" crossorigin="anonymous"></script>
    
    <!-- Load application styles -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Main Application Container -->
    <div id="app" class="app">
        
        <!-- Authentication View -->
        <div id="auth-view" class="auth-container">
            <div class="auth-card">
                <div class="card__body">
                    <!-- Logo and Title Section -->
                    <div class="logo-section">
                        <h1>üåâ DriveBridge</h1>
                        <p class="subtitle">Secure Cloud File Transfer</p>
                        <div class="version-info">v2.0 ‚Ä¢ Chunked Transfer Engine</div>
                    </div>
                    
                    <!-- Description -->
                    <div class="description">
                        <p>Transfer files seamlessly between Google Drive and OneDrive with advanced chunked transfers, comprehensive logging, and enterprise-grade security.</p>
                    </div>
                    
                    <!-- Security Notice -->
                    <div class="security-notice">
                        <p class="security-text">
                            üîí Your data never touches our servers. All transfers happen directly between your browser and cloud services.
                        </p>
                    </div>
                    
                    <!-- Authentication Buttons -->
                    <div class="auth-buttons">
                        <!-- Google Drive Authentication -->
                        <div class="service-card">
                            <div class="service-info">
                                <h3>üìÅ Google Drive</h3>
                                <div class="connection-status" id="google-status">
                                    <span class="status status--error">Disconnected</span>
                                </div>
                            </div>
                            <button id="google-auth-btn" class="btn btn--primary">
                                Connect Google Drive
                            </button>
                        </div>
                        
                        <!-- OneDrive Authentication -->
                        <div class="service-card">
                            <div class="service-info">
                                <h3>‚òÅÔ∏è OneDrive</h3>
                                <div class="connection-status" id="onedrive-status">
                                    <span class="status status--error">Disconnected</span>
                                </div>
                            </div>
                            <button id="onedrive-auth-btn" class="btn btn--primary">
                                Connect OneDrive
                            </button>
                        </div>
                    </div>
                    
                    <!-- Proceed Section -->
                    <div class="proceed-section">
                        <button id="proceed-btn" class="btn btn--transfer" disabled>
                            üöÄ Launch DriveBridge Dashboard
                        </button>
                        <p style="margin-top: var(--spacing-sm); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                            Connect both services to continue
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard View -->
        <div id="dashboard-view" class="dashboard" style="display: none;">
            
            <!-- Header -->
            <header class="header">
                <div class="header__content">
                    <h1 class="header__title">üåâ DriveBridge</h1>
                    <div class="header__actions">
                        <button id="refresh-btn" class="btn btn--secondary" title="Refresh file lists (Ctrl+R)">
                            üîÑ Refresh
                        </button>
                        <button id="download-logs-btn" class="btn btn--secondary" title="Download verbose logs (Ctrl+L)">
                            üìÑ Export Logs
                        </button>
                        <button id="disconnect-all-btn" class="btn btn--ghost">
                            üîå Disconnect All
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- File Browser -->
            <main class="file-browser">
                
                <!-- Google Drive Panel -->
                <section class="panel panel--google">
                    <div class="panel__header">
                        <h2>üìÅ Google Drive <span class="chunked-indicator">Chunked Download</span></h2>
                        <div class="panel__actions">
                            <input type="text" id="google-search" class="search-input" placeholder="Search files..." autocomplete="off">
                            <button id="google-select-all" class="btn btn--ghost btn--small">Select All</button>
                            <button id="google-clear-all" class="btn btn--ghost btn--small">Clear</button>
                            <button id="google-new-folder" class="btn btn--secondary btn--small" title="Create new folder">üìÅ+</button>
                        </div>
                    </div>
                    
                    <!-- Breadcrumb Navigation -->
                    <div id="google-breadcrumb" class="breadcrumb">
                        <span class="breadcrumb__item breadcrumb__item--active">Root</span>
                    </div>
                    
                    <!-- File List -->
                    <div id="google-file-list" class="file-list">
                        <div class="loading">Loading Google Drive files...</div>
                    </div>
                    
                    <!-- Transfer Actions -->
                    <div class="transfer-actions">
                        <button id="transfer-to-onedrive" class="btn btn--transfer" disabled>
                            Transfer Selected to OneDrive ‚Üí <span class="chunked-badge">CHUNKED</span>
                        </button>
                    </div>
                </section>
                
                <!-- OneDrive Panel -->
                <section class="panel panel--onedrive">
                    <div class="panel__header">
                        <h2>‚òÅÔ∏è OneDrive <span class="chunked-indicator">Chunked Upload</span></h2>
                        <div class="panel__actions">
                            <input type="text" id="onedrive-search" class="search-input" placeholder="Search files..." autocomplete="off">
                            <button id="onedrive-select-all" class="btn btn--ghost btn--small">Select All</button>
                            <button id="onedrive-clear-all" class="btn btn--ghost btn--small">Clear</button>
                            <button id="onedrive-new-folder" class="btn btn--secondary btn--small" title="Create new folder">üìÅ+</button>
                        </div>
                    </div>
                    
                    <!-- Breadcrumb Navigation -->
                    <div id="onedrive-breadcrumb" class="breadcrumb">
                        <span class="breadcrumb__item breadcrumb__item--active">Root</span>
                    </div>
                    
                    <!-- File List -->
                    <div id="onedrive-file-list" class="file-list">
                        <div class="loading">Loading OneDrive files...</div>
                    </div>
                    
                    <!-- Transfer Actions -->
                    <div class="transfer-actions">
                        <button id="transfer-to-google" class="btn btn--transfer" disabled>
                            ‚Üê Transfer Selected to Google Drive
                        </button>
                    </div>
                </section>
                
            </main>
            
        </div>
        
    </div>
    
    <!-- Transfer Progress Panel -->
    <div id="transfer-progress" class="transfer-progress" style="display: none;">
        <div class="transfer-header">
            <h3>üìä Transfer Progress</h3>
            <div class="transfer-controls">
                <button id="toggle-logs-btn" class="btn btn--ghost btn--small" title="Toggle logs visibility">üëÅÔ∏è Hide</button>
                <button id="clear-logs-btn" class="btn btn--ghost btn--small" title="Clear transfer logs">üóëÔ∏è Clear</button>
                <button id="download-logs-btn" class="btn btn--ghost btn--small" title="Download detailed logs">üìÑ Export</button>
            </div>
        </div>
        <div id="transfer-list" class="transfer-logs">
            <!-- Dynamic progress bars and logs will be inserted here -->
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notifications" class="notifications">
        <!-- Dynamic notifications will be inserted here -->
    </div>
    
    <!-- Modal Overlay (for dynamic modals) -->
    <div id="modal-overlay" class="modal-overlay hidden" role="presentation">
        <!-- Dynamic modals will be inserted here -->
    </div>
    
    <!-- Loading Scripts -->
    <script>
        console.log('üöÄ DriveBridge v2.0 - Production Ready');
        console.log('üìä Chunked Transfer Engine: Enabled');
        console.log('üìù Verbose Logging: Enabled');
        console.log('üîí Security Headers: Active');
    </script>
    
    <!-- Load Application Scripts in Order -->
    <script src="config.js"></script>
    
    <!-- Emergency Inline Logger (bypasses broken logger.js) -->
    <script>
        console.log('üö® Loading emergency Logger...');
        
        class Logger {
            constructor() {
                this.logs = [];
                this.sessionId = 'session_' + Date.now();
                this.startTime = Date.now();
                console.log('‚úÖ Emergency Logger initialized');
            }

            log(level, message, data, category) {
                const entry = {
                    timestamp: new Date().toISOString(),
                    level: level || 'INFO',
                    message: message || '',
                     data || {},
                    category: category || 'GENERAL',
                    id: Date.now() + Math.random()
                };
                this.logs.push(entry);
                console.log('[' + level + '] [' + category + '] ' + message, data);
                if (this.logs.length > 1000) this.logs = this.logs.slice(-500);
            }

            error(message, data, category) { this.log('ERROR', message, data, category || 'ERROR'); }
            warn(message, data, category) { this.log('WARN', message, data, category || 'WARNING'); }
            info(message, data, category) { this.log('INFO', message, data, category || 'INFO'); }
            debug(message, data, category) { this.log('DEBUG', message, data, category || 'DEBUG'); }
            trace(message, data, category) { this.log('TRACE', message, data, category || 'TRACE'); }

            transferStart(transferId, fileCount, source, destination) {
                this.info('Transfer session started', { transferId: transferId, fileCount: fileCount, source: source, destination: destination }, 'TRANSFER');
            }

            transferComplete(transferId, results) {
                this.info('Transfer session completed', { transferId: transferId, results: results }, 'TRANSFER');
            }

            fileTransferStart(fileId, fileName, fileSize, chunkCount) {
                this.info('File transfer started: ' + fileName, { fileId: fileId, fileName: fileName, fileSize: fileSize, chunkCount: chunkCount }, 'FILE_TRANSFER');
            }

            fileTransferComplete(fileId, fileName, success, error) {
                if (success) {
                    this.info('File transfer completed: ' + fileName, { fileId: fileId, fileName: fileName, success: success }, 'FILE_TRANSFER');
                } else {
                    this.error('File transfer failed: ' + fileName, { fileId: fileId, fileName: fileName, success: success, error: error }, 'FILE_TRANSFER');
                }
            }

            chunkTransfer(fileId, fileName, chunkIndex, totalChunks, success, error, retryCount) {
                const message = 'Chunk ' + (chunkIndex + 1) + '/' + totalChunks + (success ? ' transferred: ' : ' failed: ') + fileName;
                this.debug(message, { fileId: fileId, chunkIndex: chunkIndex, totalChunks: totalChunks, success: success, error: error, retryCount: retryCount }, 'CHUNK_TRANSFER');
            }

            apiCall(method, url, success, responseStatus, duration, error) {
                const message = 'API ' + method + (success ? ' success: ' : ' failed: ') + url;
                if (success) {
                    this.debug(message, { method: method, responseStatus: responseStatus, duration: duration }, 'API_CALL');
                } else {
                    this.error(message, { method: method, responseStatus: responseStatus, duration: duration, error: error }, 'API_CALL');
                }
            }

            getRecentLogs(count) {
                return this.logs.slice(-(count || 50)).map(function(log) {
                    return {
                        timestamp: new Date(log.timestamp).toLocaleTimeString(),
                        level: log.level,
                        category: log.category,
                        message: log.message,
                        id: log.id
                    };
                });
            }

            getFailedTransfers() {
                const failed = [];
                for (let i = 0; i < this.logs.length; i++) {
                    const log = this.logs[i];
                    if (log.category === 'FILE_TRANSFER' && log.data && log.data.success === false) {
                        failed.push({
                            fileName: log.data.fileName || 'Unknown',
                            error: (log.data.error && log.data.error.message) || 'Unknown error',
                            timestamp: log.timestamp,
                            fileId: log.data.fileId
                        });
                    }
                }
                return failed;
            }

            downloadLogFile() {
                try {
                    const header = '# DriveBridge Transfer Log\n# Session ID: ' + this.sessionId + '\n# Generated: ' + new Date().toISOString() + '\n# Total Entries: ' + this.logs.length + '\n\n';
                    const logContent = this.logs.map(function(log) {
                        return '[' + log.timestamp + '] [' + log.level + '] [' + log.category + '] ' + log.message;
                    }).join('\n');
                    
                    const blob = new Blob([header + logContent], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'drivebridge-log-' + this.sessionId + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(function() {
                        window.URL.revokeObjectURL(url);
                        if (document.body.contains(a)) document.body.removeChild(a);
                    }, 100);
                    
                    this.info('Log file downloaded');
                    return true;
                } catch (error) {
                    console.error('Failed to download log file:', error);
                    return false;
                }
            }

            clearLogs() {
                const oldCount = this.logs.length;
                this.logs = [];
                this.sessionId = 'session_' + Date.now();
                this.info('Logs cleared. Previous count: ' + oldCount);
            }
        }

        window.Logger = Logger;
        console.log('‚úÖ Emergency Logger ready');
    </script>
    
    <!-- Continue with other scripts -->
    <script src="ui-manager.js"></script>
    <script src="chunked-transfer.js"></script>
    <script src="error-handler.js"></script>
    <script src="app.js"></script>
    
    <!-- Performance and Analytics -->
    <script>
        // Performance monitoring
        window.addEventListener('load', function() {
            if ('performance' in window) {
                const loadTime = Math.round(performance.now());
                console.log(`‚ö° DriveBridge loaded in ${loadTime}ms`);
                
                // Log performance metrics
                if (window.logger) {
                    window.logger.info('Application loaded', {
                        loadTime: loadTime,
                        userAgent: navigator.userAgent.substring(0, 100),
                        screenResolution: `${screen.width}x${screen.height}`,
                        timestamp: Date.now()
                    }, 'PERFORMANCE');
                }
            }
        });
        
        // Error boundary for unhandled errors
        window.addEventListener('error', function(e) {
            console.error('üö® Global Error:', e.error);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('üö® Unhandled Promise Rejection:', e.reason);
        });
        
        // Accessibility improvements
        document.addEventListener('keydown', function(e) {
            // Skip links for keyboard navigation
            if (e.key === 'Tab' && e.shiftKey && e.target === document.body) {
                const firstFocusable = document.querySelector('button, input, [tabindex]');
                if (firstFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            }
        });
        
        // Progressive Web App features
        if ('serviceWorker' in navigator) {
            // Disabled for now to avoid caching issues during development
            // navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
        
        // Wake lock support detection
        if ('wakeLock' in navigator) {
            console.log('‚úÖ Wake Lock API supported - large transfers will prevent screen sleep');
        } else {
            console.log('‚ö†Ô∏è Wake Lock API not supported in this browser');
        }
        
        // Clipboard API detection
        if (navigator.clipboard && navigator.clipboard.writeText) {
            console.log('‚úÖ Clipboard API supported - share links will copy automatically');
        } else {
            console.log('‚ö†Ô∏è Clipboard API not supported - share links will be displayed');
        }
        
        // Network information (experimental)
        if ('connection' in navigator) {
            const connection = navigator.connection;
            console.log(`üì° Network: ${connection.effectiveType} (${connection.downlink} Mbps)`);
        }
        
        // Touch device detection
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (isTouchDevice) {
            document.body.classList.add('touch-device');
            console.log('üì± Touch device detected');
        }
    </script>
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "DriveBridge",
        "description": "Secure, chunked file transfer between Google Drive and OneDrive",
        "url": "https://lynchypin.github.io/drivebridge/",
        "applicationCategory": "ProductivityApplication",
        "operatingSystem": "Web Browser",
        "browserRequirements": "Modern browser with ES6+ support",
        "author": {
            "@type": "Organization",
            "name": "DriveBridge"
        },
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "Chunked file transfers",
            "Direct browser-to-cloud transfer",
            "Google Drive integration",
            "OneDrive integration",
            "Verbose logging",
            "Enterprise security"
        ]
    }
    </script>

</body>
</html>
